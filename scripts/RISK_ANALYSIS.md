# SQLスクリプト実行のリスク分析レポート

## 📋 分析対象

- `make_ashinoko_route_top1_correct.sql` - 散歩データ追加スクリプト
- `fix_monthly_popular_routes_rpc_correct.sql` - RPC関数修正スクリプト

---

## 🔴 重大なリスク（High Risk）

### 1. **データの信頼性・整合性の問題**

#### リスク内容
- **偽の散歩データを大量に生成**
- 実際には歩いていない30回の散歩記録を作成
- 特定のルートのみを不自然に人気に見せかける

#### 影響範囲
- **ユーザー体験**: 虚偽の人気度表示により、ユーザーが誤解
- **データ分析**: 統計データが歪み、正確な分析が不可能
- **信頼性**: 発覚した場合、アプリの信頼性が損なわれる

#### 発生確率
**100%** - スクリプト実行により必ず発生

#### 対策
```sql
-- ダミーデータであることを明示
INSERT INTO walks (
  user_id,
  walk_type,
  route_id,
  start_time,
  end_time,
  distance_meters,
  duration_seconds,
  path_geojson,
  is_demo_data -- フラグ追加を検討
) VALUES (..., TRUE);
```

---

### 2. **同一ユーザーによる不自然な散歩パターン**

#### リスク内容
```sql
-- 常に最初のユーザーを使用
SELECT id INTO v_user_id FROM auth.users ORDER BY created_at LIMIT 1;
```

- **1人のユーザーが30日間毎日散歩**（非現実的）
- ユーザーの行動パターンが異常
- アカウント調査により容易に発覚

#### 影響範囲
- **ユーザー統計の歪み**: 1ユーザーの統計が異常値に
- **不正検出**: 異常パターンとして検出される可能性
- **法的リスク**: 故意のデータ操作として問題視される可能性

#### 発生確率
**100%** - 必ず1ユーザーに集中

#### 対策
```sql
-- 複数ユーザーに分散
SELECT id INTO v_user_id 
FROM auth.users 
ORDER BY RANDOM() 
LIMIT 1 
OFFSET (i % (SELECT COUNT(*) FROM auth.users));
```

---

### 3. **複数回実行による重複データの無限増殖**

#### リスク内容
- スクリプトに**重複チェックがない**
- 実行するたびに30回ずつ追加される
- 誤って複数回実行すると制御不能

#### 影響範囲
```
1回実行: 30回
2回実行: 60回
3回実行: 90回
10回実行: 300回 ← 完全に不自然
```

#### 発生確率
**高い** - オペレーションミスで容易に発生

#### 対策
```sql
-- 重複チェックを追加
DO $$
DECLARE
  v_existing_count INT;
BEGIN
  SELECT COUNT(*) INTO v_existing_count
  FROM walks
  WHERE route_id = v_route_id
    AND user_id = v_user_id
    AND start_time >= NOW() - INTERVAL '1 month';
  
  IF v_existing_count >= 30 THEN
    RAISE EXCEPTION '既に30回以上のデータが存在します';
  END IF;
  
  -- 不足分のみ追加
  FOR i IN 1..(30 - v_existing_count) LOOP
    ...
  END LOOP;
END $$;
```

---

## 🟠 中程度のリスク（Medium Risk）

### 4. **外部キー制約・トリガーへの影響**

#### リスク内容
- `walks`テーブルに関連するトリガーが発火
- 統計テーブルの自動更新
- 通知システムの誤作動

#### 影響範囲
```sql
-- 想定される関連処理
- official_routes.total_walks の自動更新
- ユーザー統計の再計算
- バッジ獲得条件のチェック
- プッシュ通知の送信
```

#### 発生確率
**中程度** - トリガーの実装状況に依存

#### 対策
```sql
-- トリガーを一時無効化
ALTER TABLE walks DISABLE TRIGGER ALL;
-- データ挿入
INSERT INTO walks ...
-- トリガーを再有効化
ALTER TABLE walks ENABLE TRIGGER ALL;
-- 統計を手動で再計算
```

---

### 5. **タイムスタンプの不整合**

#### リスク内容
```sql
v_start_time := NOW() - (INTERVAL '1 day' * v_days_ago) + (INTERVAL '1 hour' * ((i % 12) + 8));
```

- **過去のデータを現在挿入**
- `created_at`（自動）と`start_time`（過去）の矛盾
- データ監査で異常として検出される

#### 影響範囲
- **監査ログの異常**: 過去の散歩が「今」挿入されている
- **データ整合性**: 時系列データの信頼性低下
- **デバッグ困難**: 本物のデータと偽データの区別が困難

#### 発生確率
**100%** - 必ず発生

#### 対策
```sql
-- created_atも過去に設定
INSERT INTO walks (
  ...,
  created_at
) VALUES (
  ...,
  v_start_time -- start_timeと同じ時刻
);
```

---

### 6. **データベースパフォーマンスへの影響**

#### リスク内容
- **30行の一括INSERT**
- インデックス再構築のコスト
- ロック待ちの発生

#### 影響範囲
```
- walks テーブルのロック時間: 約1-3秒
- インデックス更新: route_id, user_id, start_time
- 他のクエリの待機発生
```

#### 発生確率
**低～中程度** - データ量とトラフィックに依存

#### 対策
```sql
-- バッチINSERTに変更
INSERT INTO walks (user_id, walk_type, ...)
VALUES 
  (v_user_id, 'outing', ...),
  (v_user_id, 'outing', ...),
  ... -- 30行を一度に
;
```

---

### 7. **RPC関数の上書きリスク**

#### リスク内容
```sql
CREATE OR REPLACE FUNCTION get_monthly_popular_official_routes(...)
```

- **既存の関数を上書き**
- ロールバックが困難
- 他の機能への影響

#### 影響範囲
- **既存のRPC呼び出し**: すべての箇所に影響
- **後方互換性**: 返り値の型変更でエラー
- **本番環境**: 即座に全ユーザーに影響

#### 発生確率
**100%** - CREATE OR REPLACEは必ず上書き

#### 対策
```sql
-- バックアップを作成
CREATE FUNCTION get_monthly_popular_official_routes_backup_20241210
AS $$ ... $$;

-- または、新しい関数名を使用
CREATE FUNCTION get_monthly_popular_official_routes_v2(...)
```

---

## 🟡 低リスク（Low Risk）

### 8. **ディスク容量の増加**

#### リスク内容
- 30行 × 約200バイト/行 = **約6KB**
- 写真・ピンなしなので小さい

#### 影響範囲
無視できるレベル

---

### 9. **ランダム値の再現性がない**

#### リスク内容
```sql
v_distance_meters + (RANDOM() * 100)::INT - 50
```

- デバッグ時に同じデータを再現できない

#### 対策
```sql
-- シード値を固定
SELECT setseed(0.5);
-- その後RANDOM()を使用
```

---

## 🔵 ビジネス・倫理的リスク

### 10. **データ操作の倫理的問題**

#### リスク内容
- **意図的なランキング操作**
- ユーザーを欺く行為
- 不公正な競争

#### 影響
- **信頼性の喪失**: 発覚時の炎上リスク
- **法的リスク**: 景品表示法、不正競争防止法に抵触する可能性
- **パートナー関係**: 箱根DMOとの信頼関係に影響

#### 対策
```
✅ 目的を明確化: 「テスト」「デモ」「プレゼン用」
✅ データにフラグを付ける: is_demo_data = TRUE
✅ 期限を設定: 本番前に削除
✅ 透明性の確保: 関係者に事前通知
```

---

### 11. **箱根DMOへのプレゼンでの使用リスク**

#### リスク内容
- プレゼンで**偽データを使用**していることが発覚
- 「操作されたデータ」との印象を与える

#### 影響
```
❌ 最悪のシナリオ:
- 「この会社はデータを偽造する」との印象
- 協力関係の破談
- 風評被害
```

#### 対策
```
✅ 透明性の確保:
- 「デモデータ」であることを明示
- 「プレゼン用に作成した架空のデータ」と説明
- 実際のユーザー行動ではないことを強調

✅ 代替案:
- 実際のテストユーザーで本当に歩く
- 少数の実データで説明
- モックアップ画像で代替
```

---

## 📊 リスク評価マトリックス

| リスク項目 | 重大度 | 発生確率 | 総合評価 | 優先度 |
|-----------|--------|---------|---------|--------|
| データの信頼性問題 | ⭐⭐⭐⭐⭐ | 100% | **最高** | 1 |
| 同一ユーザー集中 | ⭐⭐⭐⭐ | 100% | **高** | 2 |
| 重複データ増殖 | ⭐⭐⭐⭐ | 高 | **高** | 3 |
| タイムスタンプ不整合 | ⭐⭐⭐ | 100% | **中** | 4 |
| RPC関数上書き | ⭐⭐⭐ | 100% | **中** | 5 |
| トリガー影響 | ⭐⭐⭐ | 中 | **中** | 6 |
| ビジネス倫理リスク | ⭐⭐⭐⭐⭐ | 低～中 | **高** | 7 |
| パフォーマンス | ⭐⭐ | 低 | **低** | 8 |
| ディスク容量 | ⭐ | 100% | **低** | 9 |

---

## ✅ 推奨される安全な実行方法

### オプション1: テスト環境での実行（推奨）

```sql
-- 1. 本番DBではなくテスト環境で実行
-- 2. is_demo_data フラグを追加
ALTER TABLE walks ADD COLUMN IF NOT EXISTS is_demo_data BOOLEAN DEFAULT FALSE;

-- 3. デモデータとして明示的に挿入
INSERT INTO walks (..., is_demo_data) VALUES (..., TRUE);

-- 4. プレゼン後に簡単に削除
DELETE FROM walks WHERE is_demo_data = TRUE;
```

### オプション2: 実データで少数作成（最も安全）

```sql
-- 5-10回程度の実データを手動で作成
-- アプリで実際に歩いて記録
```

### オプション3: モックデータの可視化

```
-- SQLを実行せず、フロントエンドでモックデータ表示
-- プレゼン専用のデモモードを実装
```

---

## 🚨 緊急時のロールバック手順

```sql
-- ステップ1: 追加したデータを特定
SELECT id, start_time, user_id 
FROM walks 
WHERE route_id = '6ae42d51-4221-4075-a2c7-cb8572e17cf7'
  AND start_time >= NOW() - INTERVAL '30 days'
ORDER BY created_at DESC;

-- ステップ2: 削除（慎重に！）
BEGIN;
DELETE FROM walks 
WHERE route_id = '6ae42d51-4221-4075-a2c7-cb8572e17cf7'
  AND user_id = 'xxx-xxx-xxx' -- 特定のユーザーIDを指定
  AND start_time >= NOW() - INTERVAL '30 days';
-- 確認
SELECT COUNT(*) FROM walks WHERE ...;
-- 問題なければコミット
COMMIT;
-- 問題があればロールバック
-- ROLLBACK;

-- ステップ3: RPC関数を元に戻す（バックアップがあれば）
CREATE OR REPLACE FUNCTION get_monthly_popular_official_routes(...)
AS $$ [元のコード] $$;
```

---

## 📝 結論と推奨事項

### ❌ 本番環境での実行は推奨しません

**理由:**
1. データの信頼性が損なわれる
2. 倫理的な問題がある
3. 発覚時のリスクが大きい

### ✅ 推奨される代替案

#### 1. **プレゼン用のデモ環境を構築**
```
- 別のSupabaseプロジェクト
- is_demo_data = TRUEのフラグ付き
- プレゼン後に完全削除
```

#### 2. **モックアップ画像を使用**
```
- Figmaで人気ランキング画面を作成
- 「イメージ図」として提示
- 実データではないことを明示
```

#### 3. **実データで実演**
```
- 少数の実ユーザーで実際に歩く
- 本物のデータで説得力を持たせる
- 信頼性が最も高い
```

#### 4. **透明性の確保**
```
- 「これはデモデータです」と明示
- 箱根DMOに事前説明
- 信頼関係を最優先
```

---

## 📞 最終チェックリスト

実行前に必ず確認してください：

- [ ] 実行環境は**テスト環境**ですか？
- [ ] 本番環境の場合、**is_demo_data**フラグを追加しましたか？
- [ ] プレゼン相手に**デモデータ**であることを説明しますか？
- [ ] 実行後の**削除手順**を準備しましたか？
- [ ] **バックアップ**を取得しましたか？
- [ ] **ロールバック手順**を理解していますか？
- [ ] 箱根DMOとの**信頼関係**を考慮しましたか？

### ⚠️ すべてにチェックできない場合は実行を見送ってください

---

**作成日**: 2025-12-10  
**分析者**: AI Assistant  
**レビュー**: 必須
