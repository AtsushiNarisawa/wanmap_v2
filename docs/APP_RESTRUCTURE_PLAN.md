# WanMap アプリ構造再設計案

## 📊 現状分析

### 現在のタブ構成
1. **ホーム** - 最新ピン、人気ルート、おすすめエリア
2. **マップ** - おでかけ散歩の中心（公式ルート、ピン）
3. **ライブラリ（Records）** - 散歩履歴、統計
4. **プロフィール** - ユーザー情報、愛犬管理

### 現在の散歩記録機能
- **お出かけ散歩** (`walking_screen.dart`) - 公式コース利用
- **日常散歩** (`daily_walking_screen.dart`) - 自由な散歩記録
- **ピン投稿** - 散歩中にスポットを記録

### 現在のスポット評価機能
- **Spot Reviews** - スポットの評価・設備情報（1ユーザー1レビュー）
- **Pin Comments** - ピンへのコメント（何度でも投稿可能）

---

## 🎯 理想の構造（新設計案）

### フッターナビゲーション（4タブ）

```
┌─────────┬─────────┬─────────┬─────────┐
│   TOP   │   MAP   │ライブラリ│プロフィール│
└─────────┴─────────┴─────────┴─────────┘
```

---

## 1️⃣ TOP タブ - 発見・閲覧

### 目的
ユーザーがお散歩コースやスポットを見つけられる

### 機能
#### A. 公式コース閲覧
- エリア別に公式コース一覧を表示
- コース詳細（距離、所要時間、難易度）
- コース上のピン投稿を表示
- コースを地図で見る（MapTabへ遷移）

#### B. ユーザーピン投稿閲覧
- 最新のピン投稿（写真付き）
- 人気のピン投稿
- エリア別ピン一覧
- ピン詳細表示（写真、評価、コメント）

#### C. スポット評価閲覧
- おすすめスポット（高評価順）
- スポット詳細（平均評価、設備情報、レビュー一覧）

### 画面構成案
```
┌────────────────────────────┐
│  TOP                       │
├────────────────────────────┤
│  🗺️ エリアから探す         │
│  ┌────┬────┬────┐          │
│  │箱根│横浜│鎌倉│ ...      │
│  └────┴────┴────┘          │
├────────────────────────────┤
│  🏃 公式コース              │
│  ┌───────────────────┐     │
│  │ DogHub周遊コース   │     │
│  │ 1.2km / 20分 / 易 │     │
│  └───────────────────┘     │
├────────────────────────────┤
│  📍 最新ピン投稿            │
│  ┌────┬────┐              │
│  │📷  │📷  │              │
│  └────┴────┘              │
├────────────────────────────┤
│  ⭐ おすすめスポット         │
│  • 芦ノ湖ビューポイント ★4.5│
│  • ランチ休憩スポット ★4.0  │
└────────────────────────────┘
```

### ファイル構成
- `lib/screens/main/tabs/top_tab.dart` （home_tab.dartをリネーム）
  - セクション：公式コース、最新ピン、おすすめスポット
- `lib/screens/discover/area_list_screen.dart` （エリア一覧）
- `lib/screens/discover/official_routes_screen.dart` （公式コース一覧）
- `lib/screens/discover/route_detail_screen.dart` （コース詳細）
- `lib/screens/discover/pin_feed_screen.dart` （ピンフィード）
- `lib/screens/discover/spot_rankings_screen.dart` （スポットランキング）

---

## 2️⃣ MAP タブ - 記録・投稿

### 目的
お散歩の記録とピン投稿を行う

### 機能
#### A. 散歩記録開始
- **お出かけ散歩**（公式コース利用）
  - 近くの公式コースを選択
  - GPS追跡＋コース上でピン投稿
  - コース完了でバッジ獲得
  
- **日常散歩**（フリー記録）
  - 自由な散歩記録
  - GPS追跡＋ピン投稿
  - 距離・時間・歩数記録

#### B. ピン投稿
- 散歩中または単独でピン投稿
- 写真、タイトル、説明、タグ
- スポット評価（★1〜5、設備情報）
- 公式コース上での投稿は自動的にコースに紐付け

### 画面構成案
```
┌────────────────────────────┐
│  MAP                       │
│                            │
│    🗺️ リアルタイム地図     │
│    • 現在地表示            │
│    • 周辺の公式コース      │
│    • ユーザーピン          │
│                            │
│  ┌─────────────────┐       │
│  │ 📍 現在地        │       │
│  └─────────────────┘       │
│                            │
│  ┌─────────────────┐       │
│  │ 🔍 検索          │       │
│  └─────────────────┘       │
│                            │
│         [FAB]              │
│      お散歩開始 🐾          │
└────────────────────────────┘
```

### FAB押下時のメニュー
```
┌────────────────────────────┐
│  散歩の種類を選択           │
├────────────────────────────┤
│  🏃 お出かけ散歩            │
│  （公式コース利用）          │
├────────────────────────────┤
│  🚶 日常散歩                │
│  （フリー記録）              │
├────────────────────────────┤
│  📍 ピン投稿のみ            │
│  （散歩記録なし）            │
└────────────────────────────┘
```

### ファイル構成
- `lib/screens/main/tabs/map_tab.dart` （既存、微調整）
- `lib/screens/walk/walk_type_selection_screen.dart` （新規：散歩タイプ選択）
- `lib/screens/outing/walking_screen.dart` （既存：お出かけ散歩）
- `lib/screens/daily/daily_walking_screen.dart` （既存：日常散歩）
- `lib/screens/pin/pin_create_screen.dart` （新規：ピン投稿のみ）
- `lib/screens/outing/spot_review_form_screen.dart` （既存：スポット評価）

---

## 3️⃣ ライブラリ タブ - 履歴・振り返り

### 目的
自分の散歩履歴とピン投稿を振り返る

### 機能
#### A. 散歩履歴
- **タブ切り替え**: 全て / お出かけ / 日常
- 散歩リスト（日付、距離、時間、ルート名）
- 散歩詳細表示（地図、ピン、統計）

#### B. ピン投稿履歴
- 自分が投稿したピン一覧
- 写真付きグリッド表示
- ピン詳細表示

#### C. 統計
- 総距離、総時間、散歩回数
- 今週/今月の統計
- レベルシステム
- エリア達成度

### 画面構成案
```
┌────────────────────────────┐
│  ライブラリ                 │
├────────────────────────────┤
│  🏆 統計サマリー            │
│  • Lv.5  総距離: 42.3km    │
│  • エリア: 18/47           │
├────────────────────────────┤
│  📊 今週の統計              │
│  3回 / 8.5km / 2時間15分  │
├────────────────────────────┤
│  [全て] [お出かけ] [日常]  │
├────────────────────────────┤
│  📅 最近の散歩              │
│  ┌───────────────────┐     │
│  │ 2024/12/15           │     │
│  │ DogHub周遊コース     │     │
│  │ 1.2km / 20分         │     │
│  └───────────────────┘     │
├────────────────────────────┤
│  📍 ピン投稿                │
│  ┌───┬───┬───┬───┐         │
│  │📷│📷│📷│📷│         │
│  └───┴───┴───┴───┘         │
└────────────────────────────┘
```

### ファイル構成
- `lib/screens/main/tabs/records_tab.dart` → `library_tab.dart` （リネーム）
- `lib/screens/library/walk_history_screen.dart` （散歩履歴詳細）
- `lib/screens/library/pin_history_screen.dart` （ピン投稿履歴）
- `lib/screens/library/statistics_screen.dart` （統計詳細）

---

## 4️⃣ プロフィール タブ - 設定・管理

### 目的
ユーザー情報、愛犬情報、アプリ設定

### 機能（現状維持）
- ユーザー情報表示・編集
- 愛犬情報管理
- 設定（通知、プライバシー、テーマ）
- ログアウト

### ファイル構成
- `lib/screens/main/tabs/profile_tab.dart` （既存、変更なし）
- `lib/screens/profile/*` （既存）

---

## 🔄 データ構造の整理

### ピン投稿の分類
```sql
-- route_pins テーブル
CREATE TABLE route_pins (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  dog_id UUID REFERENCES dogs,
  route_id UUID REFERENCES official_routes, -- NULLなら日常散歩
  
  -- 基本情報
  title TEXT NOT NULL,
  description TEXT,
  location GEOGRAPHY(POINT),
  pin_type TEXT, -- 'photo', 'spot', 'event'
  
  -- タイムスタンプ
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### スポット評価の扱い
- `spot_reviews` テーブルは `route_pins` とは別の独立した評価システム
- 1つのピンに対して：
  - **ピン投稿** (`route_pins`) - 1回のみ、投稿者の記録
  - **スポット評価** (`spot_reviews`) - 1ユーザー1評価、客観的評価
  - **コメント** (`pin_comments`) - 何度でも、会話・交流

---

## 📋 実装ロードマップ

### Phase 1: タブの再編成（優先度：高）
- [ ] `home_tab.dart` → `top_tab.dart` にリネーム
- [ ] `records_tab.dart` → `library_tab.dart` にリネーム
- [ ] TOPタブの内容を「発見」に特化
- [ ] ライブラリタブを「履歴」に特化

### Phase 2: MAP タブの強化（優先度：高）
- [ ] 散歩タイプ選択画面を追加
- [ ] FABから3種類の散歩開始を選択可能に
- [ ] ピン投稿のみの機能を追加

### Phase 3: 発見機能の充実（優先度：中）
- [ ] エリア別公式コース一覧
- [ ] おすすめスポットランキング
- [ ] ピンフィード（最新・人気）

### Phase 4: UI/UX改善（優先度：中）
- [ ] タブアイコンの調整
- [ ] 各画面のヘッダー統一
- [ ] ナビゲーションフローの最適化

### Phase 5: データ整理（優先度：低）
- [ ] 既存データの移行（必要に応じて）
- [ ] 不要な機能の削除

---

## 🎨 タブアイコン案

### 新しいタブアイコン
```
TOP:        explore / explore_outlined
MAP:        map / map_outlined
ライブラリ:  collections / collections_outlined
プロフィール: person / person_outline
```

---

## ✅ 確認事項

1. **TOPタブの名称**: 「TOP」「発見」「ホーム」のどれが良いか？
2. **散歩タイプ選択**: FABから選択 vs. MAP画面に3つのボタン配置
3. **ピン投稿**: 散歩中のみ vs. いつでも投稿可能
4. **スポット評価**: ピン詳細画面に統合 vs. 独立した画面
5. **既存データ**: 移行が必要なデータはあるか？

---

## 💡 追加提案

### A. 散歩中のピン投稿フロー改善
```
散歩中 → ピン投稿ボタン → 写真撮影 → 
タイトル入力 → スポット評価（任意） → 投稿完了
```

### B. ピン詳細画面の統合
```
┌────────────────────────────┐
│  📷 写真ギャラリー          │
├────────────────────────────┤
│  📍 基本情報                │
│  • タイトル、説明、場所     │
├────────────────────────────┤
│  ⭐ スポット評価（集約）     │ ← spot_reviews
│  • 平均★4.5 (3件)          │
│  • 設備情報                 │
│  • [評価する]ボタン         │
├────────────────────────────┤
│  💬 コメント                │ ← pin_comments
│  • 自由な会話・質問         │
│  • [コメントする]           │
└────────────────────────────┘
```

### C. 公式コース上のピン投稿の自動紐付け
- お出かけ散歩中のピン投稿は自動的に `route_id` を設定
- コース詳細画面でコース上のピン投稿を表示
- コースの評価に反映

---

## 📝 次のアクション

どの部分から実装を開始しますか？

1. **タブのリネームと再編成** （最も簡単、影響範囲大）
2. **MAP タブの散歩タイプ選択機能** （ユーザー体験の向上）
3. **TOP タブの発見機能強化** （新規ユーザー獲得に重要）
4. **ピン詳細画面の統合** （データ構造の整理）

ご意見・ご要望をお聞かせください！
