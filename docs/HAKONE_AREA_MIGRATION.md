# 箱根エリア分割マイグレーション手順書

## 📋 概要

箱根エリアを5つのサブエリアに分割し、渋滞緩和のため各エリアに最適なアクセスルートを提案します。

**目的**: 
- 国道1号線の渋滞緩和
- 複数のアクセスルートを観光客に提案
- 御殿場IC、三島IC、箱根新道、ターンパイクなど代替ルートの活用

---

## 🎯 実施内容

### **変更対象**
- `areas` テーブル: 5つの新エリアを追加
- `official_routes` テーブル: 既存4ルートのarea_idを適切な新エリアに更新

### **データベース変更なし**
- テーブル構造の変更なし
- カラムの追加・削除なし
- 既存データの削除なし（箱根エリアは保持）

---

## 📊 現在のデータ

### **既存の箱根エリア**
- **ID**: `a1111111-1111-1111-1111-111111111111`
- **名前**: 箱根
- **都道府県**: 神奈川県
- **座標**: 35.2328, 139.0268
- **紐づくルート数**: 4

### **既存ルート**
1. DogHub周遊コース (easy, 1.2km, 25分)
2. 箱根旧街道散歩道 (moderate, 3.5km, 75分)
3. 芦ノ湖湖畔散歩コース (easy, 2.5km, 50分)
4. 芦ノ湖畔ロングウォーク (hard, 6.8km, 150分)

---

## 🗾 新エリア設計（5エリア）

### **1️⃣ 箱根湯本・塔ノ沢エリア**
- **推奨アクセス**: 国道1号線（小田原方面）
- **中心座標**: 35.2328, 139.1071
- **特徴**: 温泉街、平坦な散策路
- **渋滞状況**: ⚠️ 混雑（特に休日）

### **2️⃣ 宮ノ下・小涌谷エリア**
- **推奨アクセス**: 箱根新道 → 県道75号
- **中心座標**: 35.2447, 139.0457
- **特徴**: 彫刻の森美術館、歴史的ホテル
- **渋滞状況**: 🟡 中程度

### **3️⃣ 強羅・早雲山エリア**
- **推奨アクセス**: 箱根新道 → 県道734号
- **中心座標**: 35.2440, 139.0273
- **特徴**: 強羅公園、眺望スポット
- **渋滞状況**: 🟢 空いている

### **4️⃣ 仙石原・大涌谷エリア**（⭐ DogHub所在地）
- **推奨アクセス**: 国道138号（御殿場IC）、箱根スカイライン（三島IC）
- **中心座標**: 35.2575, 139.0186
- **特徴**: DogHub、すすき草原、広々とした散策路
- **渋滞状況**: 🟢 空いている（裏ルート）

### **5️⃣ 芦ノ湖・元箱根エリア**
- **推奨アクセス**: 国道1号（三島側）、箱根ターンパイク
- **中心座標**: 35.2044, 139.0253
- **特徴**: 芦ノ湖、箱根神社、海賊船
- **渋滞状況**: 🟡 中程度

---

## 📝 マイグレーションSQL

### **ステップ1: 5つの新エリアを追加**

```sql
-- 箱根を5つのサブエリアに分割
-- 既存の箱根エリア（親エリア）は保持

-- 1. 箱根湯本・塔ノ沢エリア
INSERT INTO areas (id, name, prefecture, description, center_point, created_at, updated_at)
VALUES (
  'b1111111-1111-1111-1111-111111111111',
  '箱根湯本・塔ノ沢',
  '神奈川県',
  '箱根の玄関口。温泉街の散策や早川沿いの遊歩道が魅力。小田原厚木道路→国道1号線でアクセス。平坦な道が多く、初心者にもおすすめ。',
  ST_SetSRID(ST_MakePoint(139.1071, 35.2328), 4326),
  NOW(),
  NOW()
);

-- 2. 宮ノ下・小涌谷エリア
INSERT INTO areas (id, name, prefecture, description, center_point, created_at, updated_at)
VALUES (
  'b2222222-2222-2222-2222-222222222222',
  '宮ノ下・小涌谷',
  '神奈川県',
  '彫刻の森美術館や歴史的ホテルが点在する文化エリア。箱根新道（小田原西IC）→県道75号でアクセス可能。適度な坂道で散歩に最適。',
  ST_SetSRID(ST_MakePoint(139.0457, 35.2447), 4326),
  NOW(),
  NOW()
);

-- 3. 強羅・早雲山エリア
INSERT INTO areas (id, name, prefecture, description, center_point, created_at, updated_at)
VALUES (
  'b3333333-3333-3333-3333-333333333333',
  '強羅・早雲山',
  '神奈川県',
  '強羅公園や箱根美術館など、眺望が楽しめるエリア。箱根新道（箱根口IC）→県道734号で国道1号線を避けてアクセス。坂道が多く上級者向け。',
  ST_SetSRID(ST_MakePoint(139.0273, 35.2440), 4326),
  NOW(),
  NOW()
);

-- 4. 仙石原・大涌谷エリア（DogHub所在地）
INSERT INTO areas (id, name, prefecture, description, center_point, created_at, updated_at)
VALUES (
  'b4444444-4444-4444-4444-444444444444',
  '仙石原・大涌谷',
  '神奈川県',
  'DogHub箱根のホームエリア。仙石原すすき草原や箱根湿生花園など、広々とした散策スポットが魅力。御殿場IC→国道138号線（20分）、または三島IC→箱根スカイライン経由で国道1号線の渋滞を回避できる裏ルート。愛犬とのんびり過ごせる開放的なエリア。',
  ST_SetSRID(ST_MakePoint(139.0186, 35.2575), 4326),
  NOW(),
  NOW()
);

-- 5. 芦ノ湖・元箱根エリア
INSERT INTO areas (id, name, prefecture, description, center_point, created_at, updated_at)
VALUES (
  'b5555555-5555-5555-5555-555555555555',
  '芦ノ湖・元箱根',
  '神奈川県',
  '芦ノ湖畔の絶景散歩コース。箱根神社や海賊船乗り場など観光スポット充実。三島IC→国道1号線（三島側から）、または御殿場IC→箱根ターンパイクで小田原側の渋滞を回避。湖畔の遊歩道は愛犬との散歩に最適。',
  ST_SetSRID(ST_MakePoint(139.0253, 35.2044), 4326),
  NOW(),
  NOW()
);
```

---

### **ステップ2: 既存ルートのarea_idを更新**

```sql
-- 既存4ルートを適切な新エリアに割り当て

-- 1. DogHub周遊コース → 仙石原・大涌谷エリア（DogHub所在地）
UPDATE official_routes
SET 
  area_id = 'b4444444-4444-4444-4444-444444444444',
  updated_at = NOW()
WHERE id = '8d0b7773-cac3-4f5b-938b-f21e92b4c0fe';

-- 2. 箱根旧街道散歩道 → 箱根湯本・塔ノ沢エリア
UPDATE official_routes
SET 
  area_id = 'b1111111-1111-1111-1111-111111111111',
  updated_at = NOW()
WHERE id = 'ad904fb6-f2bd-423c-b7b6-a6abd44b054f';

-- 3. 芦ノ湖湖畔散歩コース → 芦ノ湖・元箱根エリア
UPDATE official_routes
SET 
  area_id = 'b5555555-5555-5555-5555-555555555555',
  updated_at = NOW()
WHERE id = 'd2a04103-3868-4e44-8fdb-eb3433d4e695';

-- 4. 芦ノ湖畔ロングウォーク → 芦ノ湖・元箱根エリア
UPDATE official_routes
SET 
  area_id = 'b5555555-5555-5555-5555-555555555555',
  updated_at = NOW()
WHERE id = '6ae42d51-4221-4075-a2c7-cb8572e17cf7';
```

---

### **ステップ3: 検証SQL**

```sql
-- 新エリア追加確認
SELECT 
  id,
  name,
  prefecture,
  ST_X(center_point::geometry) as longitude,
  ST_Y(center_point::geometry) as latitude
FROM areas
WHERE prefecture = '神奈川県'
ORDER BY name;

-- ルート割り当て確認
SELECT 
  r.name as route_name,
  a.name as area_name,
  r.difficulty_level,
  r.distance_meters
FROM official_routes r
JOIN areas a ON r.area_id = a.id
WHERE a.prefecture = '神奈川県'
ORDER BY a.name, r.name;

-- 各エリアのルート数確認
SELECT 
  a.name as area_name,
  COUNT(r.id) as route_count
FROM areas a
LEFT JOIN official_routes r ON a.id = r.area_id
WHERE a.prefecture = '神奈川県'
GROUP BY a.id, a.name
ORDER BY a.name;
```

---

## ⚠️ 注意事項

### **実行前の確認**
1. ✅ データベースのバックアップを取得
2. ✅ 外部キー制約を確認済み（`official_routes_area_id_fkey`）
3. ✅ 既存の箱根エリア（親）は削除しない
4. ✅ 新しいUUIDは重複しないことを確認

### **影響範囲**
- **Flutterアプリ**: コード変更不要（area_idで動的に取得）
- **エリア一覧画面**: 箱根が5つに分割されて表示される
- **ルート検索**: 各エリアごとにルートが表示される
- **RPC関数**: `get_routes_by_area_geojson` が新area_idで正常動作

### **ロールバック方法**
```sql
-- 万が一戻す場合
UPDATE official_routes
SET area_id = 'a1111111-1111-1111-1111-111111111111'
WHERE area_id IN (
  'b1111111-1111-1111-1111-111111111111',
  'b2222222-2222-2222-2222-222222222222',
  'b3333333-3333-3333-3333-333333333333',
  'b4444444-4444-4444-4444-444444444444',
  'b5555555-5555-5555-5555-555555555555'
);

DELETE FROM areas
WHERE id IN (
  'b1111111-1111-1111-1111-111111111111',
  'b2222222-2222-2222-2222-222222222222',
  'b3333333-3333-3333-3333-333333333333',
  'b4444444-4444-4444-4444-444444444444',
  'b5555555-5555-5555-5555-555555555555'
);
```

---

## 🎯 実行手順（Mac側）

### **1. バックアップ**
```bash
# Supabase Dashboard → Database → Backups
# 手動バックアップを作成
```

### **2. SQL実行**
```bash
# Supabase Dashboard → SQL Editor
# ステップ1のSQLを実行（新エリア追加）
# ステップ2のSQLを実行（ルート更新）
# ステップ3のSQLを実行（検証）
```

### **3. Flutterアプリで確認**
```bash
cd ~/projects/webapp/wanmap_v2
flutter run
# または Hot Restart

# 確認項目:
# - エリア一覧に5つの箱根エリアが表示される
# - 各エリアをタップしてルート一覧が表示される
# - DogHub周遊コースが「仙石原・大涌谷」エリアにある
# - 芦ノ湖のルートが「芦ノ湖・元箱根」エリアにある
```

---

## 📊 実行後の状態

### **エリア一覧**
- 箱根（親エリア、ルート0件）
- 箱根湯本・塔ノ沢（1ルート）
- 宮ノ下・小涌谷（0ルート）
- 強羅・早雲山（0ルート）
- 仙石原・大涌谷（1ルート、DogHub）
- 芦ノ湖・元箱根（2ルート）

### **ルート配置**
- DogHub周遊コース → 仙石原・大涌谷
- 箱根旧街道散歩道 → 箱根湯本・塔ノ沢
- 芦ノ湖湖畔散歩コース → 芦ノ湖・元箱根
- 芦ノ湖畔ロングウォーク → 芦ノ湖・元箱根

---

## ✅ 完了チェックリスト

- [ ] バックアップ取得完了
- [ ] ステップ1 SQL実行（新エリア追加）
- [ ] ステップ2 SQL実行（ルート更新）
- [ ] ステップ3 SQL実行（検証）
- [ ] Flutterアプリで動作確認
- [ ] エリア一覧に5つの箱根エリア表示確認
- [ ] 各ルートが正しいエリアに表示確認
- [ ] DogHubエリアの確認

---

作成日: 2025-12-16
作成者: WanMap開発チーム
