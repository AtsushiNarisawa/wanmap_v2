# WanMap v2 - 画面遷移図（Screen Transition Diagram）

**作成日**: 2025-11-24  
**バージョン**: v2 (Phase 3実装中)  
**プロジェクト**: WanMap - 愛犬の散歩ルート共有モバイルアプリ

---

## 📋 目次

1. [メイン画面構造（4タブ）](#メイン画面構造4タブ)
2. [Home Tab - ホーム画面](#home-tab---ホーム画面)
3. [Map Tab - マップビュー](#map-tab---マップビュー)
4. [Records Tab - 記録タブ](#records-tab---記録タブ)
5. [Profile Tab - プロフィールタブ](#profile-tab---プロフィールタブ)
6. [日常散歩フロー（Daily Walk）](#日常散歩フローdaily-walk)
7. [おでかけ散歩フロー（Outing Walk）](#おでかけ散歩フローouting-walk)
8. [ソーシャル機能フロー](#ソーシャル機能フロー)
9. [実装状況凡例](#実装状況凡例)

---

## メイン画面構造（4タブ）

```
┌────────────────────────────────────────────────────────────┐
│                   WanMap v2                                 │
│              MainScreen (4タブUI)                           │
├──────────┬──────────┬──────────┬──────────────────────────┤
│   Home   │   Map    │  Records │   Profile                 │
│    🏠    │   🗺️    │    📊    │     👤                   │
└──────────┴──────────┴──────────┴──────────────────────────┘

凡例:
  ✅ = 完全実装済み・動作確認済み
  ⚠️ = 実装済みだが問題あり
  🔄 = 実装中
  ❌ = 未実装またはエラー発生中
```

---

## Home Tab - ホーム画面

### 画面構成

```
┌─────────────────────────────────────────┐
│        Home Tab - ホーム画面             │
├─────────────────────────────────────────┤
│                                         │
│  🎨 ヘッダー                            │
│    - アプリロゴ                         │
│    - 通知アイコン 🔔                    │
│                                         │
│  📍 おすすめエリア（横スクロール）       │
│    ┌────────┐ ┌────────┐ ┌────────┐  │
│    │  箱根  │ │  横浜  │ │  鎌倉  │  │
│    │  🗻   │ │  🌊   │ │  ⛩️  │  │
│    └────────┘ └────────┘ └────────┘  │
│                                         │
│    [エリアを探す] → AreaListScreen ❌   │
│                                         │
│  ⭐ 人気の公式ルート                    │
│    ┌─────────────────────────────┐    │
│    │ 🗻 箱根湖畔コース (3.2km)    │    │
│    │ ⭐⭐⭐⭐☆  難易度: Easy      │    │
│    └─────────────────────────────┘    │
│    ┌─────────────────────────────┐    │
│    │ 🌸 横浜山手散策コース (2.5km)│    │
│    │ ⭐⭐⭐☆☆  難易度: Easy      │    │
│    └─────────────────────────────┘    │
│                                         │
│  🚀 クイックアクション                  │
│    ┌──────┐ ┌──────┐                 │
│    │ エリア│ │ ルート│                 │
│    │ 検索 │ │ 検索 │                 │
│    └──────┘ └──────┘                 │
│    ┌──────┐ ┌──────┐                 │
│    │ 日常 │ │ 散歩 │                 │
│    │ 散歩 │ │ 記録 │                 │
│    └──────┘ └──────┘                 │
│                                         │
└─────────────────────────────────────────┘
```

### 遷移フロー

```
Home Tab
  │
  ├─ おすすめエリア
  │   └─ [エリアを探す] → AreaListScreen ❌ エラー中
  │       │
  │       └─ エリア選択 → RouteListScreen
  │           │
  │           └─ ルート選択 → RouteDetailScreen ✅
  │
  ├─ 人気の公式ルート
  │   └─ ルートカードタップ → RouteDetailScreen ✅
  │
  └─ クイックアクション（4ボタン）
      ├─ [エリア検索] → AreaListScreen ❌
      ├─ [ルート検索] → RouteSearchScreen
      ├─ [日常散歩] → DailyWalkView ✅
      │   └─ → DailyWalkingScreen ✅
      └─ [散歩記録] → WalkHistoryScreen

【実装状況】
✅ ホーム画面レイアウト完成
✅ クイックアクション動作
❌ エリア一覧取得エラー（type 'Null' is not a subtype of type 'num'）
⚠️ ホーム画面スクロール問題（クイックアクション下のコンテンツ）
```

---

## Map Tab - マップビュー

### 画面構成

```
┌─────────────────────────────────────────┐
│         Map Tab - マップビュー           │
├─────────────────────────────────────────┤
│                                         │
│           🗺️ 地図表示エリア             │
│                                         │
│      ┌─────────────────────────┐       │
│      │                         │       │
│      │    📍 現在地             │       │
│      │                         │       │
│      │    🗺️ Thunderforest     │       │
│      │       Outdoors Tiles    │       │
│      │                         │       │
│      └─────────────────────────┘       │
│                                         │
│  🔘 現在地ボタン（右下）                │
│  🎚️ ズームコントロール（右側）          │
│                                         │
└─────────────────────────────────────────┘
```

### 遷移フロー

```
Map Tab
  └─ 現在地中心のマップ表示 ⚠️

【実装状況】
✅ flutter_map 統合完了
✅ Thunderforest APIキー更新済み
⚠️ 地図タイル表示問題あり（断続的に401エラー）
✅ GPS現在地取得機能
```

---

## Records Tab - 記録タブ

### 画面構成

```
┌─────────────────────────────────────────┐
│       Records Tab - 記録タブ             │
├─────────────────────────────────────────┤
│                                         │
│  📊 統計サマリーカード                   │
│    ┌─────────────────────────────┐     │
│    │  📏 総距離: 127.5 km         │     │
│    │  ⏱️ 総時間: 45h 30m          │     │
│    │  🎯 レベル: 12 (120km/130km) │     │
│    │  ━━━━━━━━━━━━━━━━━━━ 92%  │     │
│    │                             │     │
│    │  🏆 獲得バッジ: 8個          │     │
│    │  🚶 散歩回数: 87回           │     │
│    │  📍 訪問エリア: 3箇所        │     │
│    └─────────────────────────────┘     │
│                                         │
│  📝 散歩履歴                             │
│    ┌─────────────────────────────┐     │
│    │ 🐕 Daily散歩                │     │
│    │ 📅 2025-11-24 07:30         │     │
│    │ 📏 2.5km | ⏱️ 35min          │     │
│    └─────────────────────────────┘     │
│    ┌─────────────────────────────┐     │
│    │ 🗻 おでかけ: 箱根湖畔コース   │     │
│    │ 📅 2025-11-23 14:00         │     │
│    │ 📏 3.2km | ⏱️ 48min | 📍2    │     │
│    └─────────────────────────────┘     │
│    ┌─────────────────────────────┐     │
│    │ 🐕 Daily散歩                │     │
│    │ 📅 2025-11-23 08:15         │     │
│    │ 📏 1.8km | ⏱️ 28min          │     │
│    └─────────────────────────────┘     │
│                                         │
│  ⭐ [お気に入り] → FavoritesScreen ✅   │
│                                         │
└─────────────────────────────────────────┘
```

### 遷移フロー

```
Records Tab
  │
  ├─ 統計サマリーカード表示 ✅
  │   ├─ 総距離（自動集計）
  │   ├─ 総時間（自動集計）
  │   ├─ レベル進捗バー
  │   ├─ 獲得バッジ数
  │   ├─ 散歩回数
  │   └─ 訪問エリア数
  │
  ├─ 散歩履歴一覧 ✅
  │   ├─ Daily散歩（日常散歩）
  │   │   └─ タップ → 散歩詳細表示
  │   └─ Outing散歩（おでかけ散歩）
  │       └─ タップ → 散歩詳細 + ピン一覧
  │
  └─ [お気に入り] → FavoritesScreen ✅
      └─ お気に入りルート一覧表示

【実装状況】
✅ 統計サマリー自動計算・表示
✅ 散歩履歴一覧表示（Daily/Outing区別）
✅ お気に入りルート機能
✅ レベルシステム（10kmで1レベル）
```

---

## Profile Tab - プロフィールタブ

### 画面構成

```
┌─────────────────────────────────────────┐
│      Profile Tab - プロフィールタブ       │
├─────────────────────────────────────────┤
│                                         │
│  👤 ユーザー情報                         │
│    ┌─────────────────────────────┐     │
│    │     🖼️ アバター画像          │     │
│    │                             │     │
│    │   📛 Atsushi Narisawa       │     │
│    │   📧 test1@example.com      │     │
│    │                             │     │
│    │   🎯 レベル 12               │     │
│    │   📏 総距離 127.5km          │     │
│    └─────────────────────────────┘     │
│                                         │
│  📊 統計情報                             │
│    [統計詳細を見る] →                    │
│         StatisticsDashboardScreen ✅    │
│                                         │
│  👥 フォロワー / フォロー                │
│    ┌──────────┐ ┌──────────┐          │
│    │ 42       │ │ 58       │          │
│    │フォロワー │ │フォロー中│          │
│    └──────────┘ └──────────┘          │
│                                         │
│    [フォロワー] → FollowersScreen       │
│    [フォロー中] → FollowingScreen       │
│                                         │
│  🏆 バッジコレクション                   │
│    ┌───┐ ┌───┐ ┌───┐ ┌───┐          │
│    │🥇│ │🥈│ │🥉│ │🔒│          │
│    └───┘ └───┘ └───┘ └───┘          │
│    8 / 17 獲得                          │
│                                         │
│  ⚙️ 設定                                 │
│    - プロフィール編集                    │
│    - プライバシー設定                    │
│    - 通知設定                            │
│    - ログアウト                          │
│                                         │
└─────────────────────────────────────────┘
```

### 遷移フロー

```
Profile Tab
  │
  ├─ ユーザー情報表示 ✅
  │   ├─ アバター画像
  │   ├─ 名前・メールアドレス
  │   ├─ レベル
  │   └─ 総距離
  │
  ├─ 統計情報 ✅
  │   └─ [統計詳細] → StatisticsDashboardScreen ✅
  │       ├─ 月別散歩距離グラフ
  │       ├─ 散歩回数カレンダー
  │       ├─ エリア別訪問回数
  │       └─ バッジ獲得履歴
  │
  ├─ フォロワー/フォロー ✅
  │   ├─ [フォロワー] → FollowersScreen ✅
  │   │   └─ フォロワー一覧
  │   └─ [フォロー中] → FollowingScreen ✅
  │       └─ フォロー中ユーザー一覧
  │
  ├─ バッジコレクション ✅
  │   └─ 獲得済み/未獲得バッジ表示
  │
  └─ 設定
      ├─ プロフィール編集 ⚠️ Phase 6予定
      ├─ プライバシー設定
      ├─ 通知設定
      └─ ログアウト ✅

【実装状況】
✅ プロフィール表示機能完成
✅ 統計ダッシュボード
✅ フォロワー/フォロー機能
✅ バッジシステム（17種類）
⚠️ プロフィール編集機能（Phase 6で実装予定）
```

---

## 日常散歩フロー（Daily Walk）

### フロー図

```
【日常散歩（Daily Walk）- プライベート記録】

1. 散歩開始
   Home Tab or QuickAction
       ↓ [日常散歩開始]
   ┌─────────────────────────────┐
   │  DailyWalkView ✅            │
   │                             │
   │  📝 散歩のタイトル入力       │
   │  ┌─────────────────────┐   │
   │  │ 朝の散歩             │   │
   │  └─────────────────────┘   │
   │                             │
   │  🐕 犬を選択（オプション）   │
   │  ┌───┐ ┌───┐ ┌───┐       │
   │  │🐕│ │🐕│ │➕│       │
   │  │Max│ │Rex│ │追加│       │
   │  └───┘ └───┘ └───┘       │
   │                             │
   │  📝 メモ（オプション）       │
   │  ┌─────────────────────┐   │
   │  │ 今日は良い天気       │   │
   │  └─────────────────────┘   │
   │                             │
   │     [散歩を開始する]         │
   └─────────────────────────────┘
       ↓
2. 散歩中
   ┌─────────────────────────────┐
   │ DailyWalkingScreen ✅        │
   │                             │
   │  🗺️ 地図表示                │
   │  ┌─────────────────────┐   │
   │  │                     │   │
   │  │    現在のルート      │   │
   │  │    📍 現在地         │   │
   │  │                     │   │
   │  └─────────────────────┘   │
   │                             │
   │  📊 統計情報                │
   │  ┌─────────────────────┐   │
   │  │ 📏 距離: 1.2 km      │   │
   │  │ ⏱️ 時間: 18:35       │   │
   │  │ 📍 ポイント数: 234    │   │
   │  └─────────────────────┘   │
   │                             │
   │  🎬 アクション               │
   │  ┌──────┐ ┌──────┐         │
   │  │ 📷   │ │ ⏸️   │         │
   │  │カメラ│ │一時停止│         │
   │  └──────┘ └──────┘         │
   │                             │
   │  [散歩を終了する]            │
   └─────────────────────────────┘
       ↓
3. 保存確認
   ┌─────────────────────────────┐
   │  散歩を終了しますか？         │
   │                             │
   │  📏 総距離: 2.5 km           │
   │  ⏱️ 総時間: 35:20            │
   │  📍 記録ポイント: 524        │
   │                             │
   │  [キャンセル] [保存して終了]  │
   └─────────────────────────────┘
       ↓
4. 完了 → Records Tab ✅
```

### 技術詳細

```
【GPS追跡】
- Geolocator パッケージ使用
- リアルタイム位置情報取得（5秒間隔）
- LatLng座標の配列に記録
- バックグラウンド追跡対応

【統計計算】 ✅ 実装済み
- 距離: Haversine公式で計算
- 時間: 開始時刻からの経過時間
- ポイント数: 記録された座標数

【写真撮影】 🔄 Phase 3実装中
- カメラボタン追加 ✅
- PhotoService実装済み ✅
- Storageアップロード処理 ⚠️ バケット名修正必要
- walk-photos バケット ❌ 未作成

【プロフィール自動更新】 ✅ 実装済み
- 総距離更新
- レベル計算（10kmで1レベル）
- 散歩回数インクリメント
```

---

## おでかけ散歩フロー（Outing Walk）

### フロー図

```
【おでかけ散歩（Outing Walk）- 公式ルートを歩く】

1. エリア選択
   Home Tab → [エリアを探す]
       ↓
   ┌─────────────────────────────┐
   │ AreaListScreen ❌ エラー中    │
   │                             │
   │  🗻 箱根エリア              │
   │  ┌─────────────────────┐   │
   │  │ 📸 エリア画像        │   │
   │  │ 🗻 箱根              │   │
   │  │ 📍 15 ルート         │   │
   │  └─────────────────────┘   │
   │                             │
   │  🌊 横浜エリア              │
   │  ┌─────────────────────┐   │
   │  │ 📸 エリア画像        │   │
   │  │ 🌊 横浜              │   │
   │  │ 📍 12 ルート         │   │
   │  └─────────────────────┘   │
   │                             │
   │  ⛩️ 鎌倉エリア              │
   │  ┌─────────────────────┐   │
   │  │ 📸 エリア画像        │   │
   │  │ ⛩️ 鎌倉              │   │
   │  │ 📍 18 ルート         │   │
   │  └─────────────────────┘   │
   └─────────────────────────────┘
       ↓ エリア選択
2. ルート選択
   ┌─────────────────────────────┐
   │ RouteListScreen ⚠️           │
   │                             │
   │  📍 箱根エリアのルート       │
   │                             │
   │  ┌─────────────────────┐   │
   │  │ 🗻 箱根湖畔コース     │   │
   │  │ 📏 3.2km | ⏱️ 45min   │   │
   │  │ ⭐⭐⭐⭐☆           │   │
   │  │ 難易度: Easy          │   │
   │  └─────────────────────┘   │
   │                             │
   │  ┌─────────────────────┐   │
   │  │ 🌸 桜並木コース       │   │
   │  │ 📏 2.8km | ⏱️ 38min   │   │
   │  │ ⭐⭐⭐☆☆           │   │
   │  │ 難易度: Easy          │   │
   │  └─────────────────────┘   │
   │                             │
   │  ┌─────────────────────┐   │
   │  │ ⛰️ 山道トレイル       │   │
   │  │ 📏 5.1km | ⏱️ 75min   │   │
   │  │ ⭐⭐⭐⭐⭐           │   │
   │  │ 難易度: Hard          │   │
   │  └─────────────────────┘   │
   └─────────────────────────────┘
       ↓ ルート選択
3. ルート詳細
   ┌─────────────────────────────┐
   │ RouteDetailScreen ✅         │
   │                             │
   │  🗻 箱根湖畔コース           │
   │                             │
   │  🗺️ ルートマップ            │
   │  ┌─────────────────────┐   │
   │  │                     │   │
   │  │  S ━━━━━━━━━ G     │   │
   │  │   🗺️ 公式ルート     │   │
   │  │                     │   │
   │  └─────────────────────┘   │
   │                             │
   │  📋 ルート情報              │
   │  📏 距離: 3.2 km             │
   │  ⏱️ 所要時間: 約45分         │
   │  📈 標高差: +120m            │
   │  ⭐ 難易度: Easy             │
   │  🚶 歩いた人: 127人          │
   │  📍 ピン: 23個               │
   │                             │
   │  💬 説明                     │
   │  芦ノ湖の美しい景色を楽しみな │
   │  がら散歩できるコースです。   │
   │                             │
   │  📍 既存のピン              │
   │  ┌───┐ ┌───┐ ┌───┐       │
   │  │📷│ │🏪│ │🐕│       │
   │  │景色│ │店舗│ │出会い│       │
   │  └───┘ └───┘ └───┘       │
   │                             │
   │  ⭐ [お気に入り登録]         │
   │  🚶 [このルートを歩く]       │
   └─────────────────────────────┘
       ↓ [このルートを歩く]
4. 散歩中
   ┌─────────────────────────────┐
   │ WalkingScreen ✅             │
   │                             │
   │  🗺️ 地図表示                │
   │  ┌─────────────────────┐   │
   │  │  公式ルート（青線）   │   │
   │  │  S ━━━━━━━━━ G     │   │
   │  │                     │   │
   │  │  現在のルート（赤線） │   │
   │  │  📍 現在地           │   │
   │  └─────────────────────┘   │
   │                             │
   │  📊 統計情報                │
   │  ┌─────────────────────┐   │
   │  │ 📏 距離: 1.8 km      │   │
   │  │ ⏱️ 時間: 24:15       │   │
   │  │ 📍 投稿ピン: 2       │   │
   │  └─────────────────────┘   │
   │                             │
   │  🎬 アクション               │
   │  ┌──────┐ ┌──────┐         │
   │  │ 📍   │ │ ⏸️   │         │
   │  │ピン投稿│ │一時停止│         │
   │  └──────┘ └──────┘         │
   │                             │
   │  [散歩を終了する]            │
   └─────────────────────────────┘
       ↓
5. ピン投稿（オプション）
   ┌─────────────────────────────┐
   │ PinCreateScreen ⚠️           │
   │                             │
   │  📝 ピンを投稿               │
   │                             │
   │  📷 写真（最大5枚）          │
   │  ┌───┐ ┌───┐ ┌───┐       │
   │  │📷│ │📷│ │➕│       │
   │  └───┘ └───┘ └───┘       │
   │                             │
   │  🏷️ ピンタイプ               │
   │  ◉ 景色  ○ 店舗              │
   │  ○ 出会い ○ その他           │
   │                             │
   │  💬 コメント                 │
   │  ┌─────────────────────┐   │
   │  │ 素晴らしい景色でした！│   │
   │  └─────────────────────┘   │
   │                             │
   │  🌐 公開設定                 │
   │  ☑️ 公開する                │
   │                             │
   │  [キャンセル] [投稿する]     │
   └─────────────────────────────┘
       ↓
6. 完了 → Records Tab ✅
   - プロフィール自動更新 ✅
   - 訪問エリア数更新 ✅
   - バッジ獲得チェック ✅
```

### 技術詳細

```
【公式ルート表示】
- official_routes テーブルから取得
- PostGIS LineString で保存
- 地図上に青線で重畳表示
- 開始地点（S）と終了地点（G）マーカー

【ピン投稿機能】
- 4タイプ: 景色/店舗/出会い/その他
- 写真最大5枚添付
- 位置情報自動記録
- 公開/非公開設定

【プロフィール自動更新】 ✅
- 総距離更新
- レベル計算
- 訪問エリア数カウント
- バッジ獲得判定
```

---

## ソーシャル機能フロー

### ユーザー検索・フォロー

```
【ユーザー検索・フォロー】

Profile Tab → [ユーザー検索]
    ↓
┌─────────────────────────────┐
│ UserSearchScreen             │
│                             │
│  🔍 検索                     │
│  ┌─────────────────────┐   │
│  │ 🔍 ユーザー名で検索  │   │
│  └─────────────────────┘   │
│                             │
│  👥 検索結果                 │
│  ┌─────────────────────┐   │
│  │ 👤 田中太郎          │   │
│  │ 📊 Lv.15 | 200km     │   │
│  │ [フォロー]           │   │
│  └─────────────────────┘   │
│  ┌─────────────────────┐   │
│  │ 👤 佐藤花子          │   │
│  │ 📊 Lv.12 | 150km     │   │
│  │ [フォロー中]         │   │
│  └─────────────────────┘   │
└─────────────────────────────┘
    ↓ ユーザー選択
┌─────────────────────────────┐
│ UserProfileScreen            │
│                             │
│  👤 田中太郎のプロフィール   │
│                             │
│  🖼️ アバター                │
│  📊 レベル 15                │
│  📏 総距離 200km              │
│  🏆 バッジ 12個               │
│                             │
│  👥 フォロワー 89 | フォロー 45│
│                             │
│  📝 最近の散歩履歴           │
│  ┌─────────────────────┐   │
│  │ 🗻 箱根湖畔コース     │   │
│  │ 📅 2025-11-23        │   │
│  │ 📏 3.2km | 📍 3      │   │
│  └─────────────────────┘   │
│                             │
│  [フォローする] [メッセージ]  │
└─────────────────────────────┘
```

### タイムライン

```
【タイムライン】

Home Tab → [タイムライン]
    ↓
┌─────────────────────────────┐
│ TimelineScreen               │
│                             │
│  📰 フォロー中の投稿         │
│                             │
│  ┌─────────────────────┐   │
│  │ 👤 田中太郎          │   │
│  │ 📅 2時間前           │   │
│  │                     │   │
│  │ 📍 箱根湖畔コース     │   │
│  │ 📷 [写真]            │   │
│  │ 💬 素晴らしい景色！   │   │
│  │                     │   │
│  │ ❤️ 24 💬 5           │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ 👤 佐藤花子          │   │
│  │ 📅 5時間前           │   │
│  │                     │   │
│  │ 📍 横浜山手散策コース │   │
│  │ 📷 [写真]            │   │
│  │ 💬 カフェに寄り道♪   │   │
│  │                     │   │
│  │ ❤️ 18 💬 3           │   │
│  └─────────────────────┘   │
│                             │
└─────────────────────────────┘
```

### 通知センター

```
【通知センター】

全画面 → 通知アイコン（ベルマーク🔔）
    ↓
┌─────────────────────────────┐
│ NotificationCenterScreen     │
│                             │
│  🔔 通知                     │
│                             │
│  ┌─────────────────────┐   │
│  │ 👤 田中太郎があなたを │   │
│  │    フォローしました   │   │
│  │ 📅 5分前             │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ ❤️ 佐藤花子があなたの │   │
│  │    ピンにいいね！     │   │
│  │ 📅 1時間前           │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ 🏆 新しいバッジを獲得！│   │
│  │ 「早起き散歩マスター」 │   │
│  │ 📅 昨日              │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ 📍 山田次郎が「横浜山 │   │
│  │    手散策コース」にピン│   │
│  │    を投稿しました     │   │
│  │ 📅 2日前             │   │
│  └─────────────────────┘   │
│                             │
└─────────────────────────────┘
```

---

## 実装状況凡例

### 画面別実装状況

| 記号 | 意味 | 説明 |
|------|------|------|
| ✅ | 完全実装済み | 機能完成・動作確認済み |
| ⚠️ | 実装済みだが問題あり | 動作するが既知の問題がある |
| 🔄 | 実装中 | 現在開発進行中 |
| ❌ | 未実装またはエラー | 未実装、またはエラーで動作しない |

### 主要画面の実装状況一覧

#### ✅ 完全実装済み

| 画面 | ファイル名 | 備考 |
|------|-----------|------|
| メイン画面 | main_screen.dart | 4タブUI完成 |
| ホームタブ | home_tab.dart | レイアウト完成 |
| 記録タブ | records_tab.dart | 統計・履歴表示完成 |
| プロフィールタブ | profile_tab.dart | プロフィール表示完成 |
| 日常散歩開始 | daily_walk_view.dart | 開始画面完成 |
| 日常散歩中 | daily_walking_screen.dart | GPS追跡・統計表示完成 |
| ルート詳細 | route_detail_screen.dart | ルート情報表示完成 |
| おでかけ散歩中 | walking_screen.dart | 公式ルート重畳表示完成 |
| お気に入り | favorites_screen.dart | お気に入りルート一覧完成 |
| 統計ダッシュボード | statistics_dashboard_screen.dart | 詳細統計表示完成 |
| フォロワー一覧 | followers_screen.dart | フォロワー一覧表示完成 |
| フォロー一覧 | following_screen.dart | フォロー中ユーザー一覧完成 |

#### ⚠️ 実装済みだが問題あり

| 画面 | ファイル名 | 問題内容 |
|------|-----------|---------|
| マップタブ | map_tab.dart | 地図タイル表示の断続的エラー |
| ルート一覧 | route_list_screen.dart | エリアエラーの影響 |
| ピン投稿 | pin_create_screen.dart | Storageバケット設定必要 |

#### ❌ 未実装またはエラー

| 画面 | ファイル名 | 問題内容 |
|------|-----------|---------|
| エリア一覧 | area_list_screen.dart | `type 'Null' is not a subtype of type 'num'` エラー |

#### 🔄 実装中（Phase 3）

| 機能 | 状態 | 備考 |
|------|------|------|
| 写真撮影機能 | 🔄 | カメラボタン追加済み |
| 写真アップロード | 🔄 | PhotoService実装済み、バケット設定必要 |

### データベーステーブル実装状況

| テーブル名 | 状態 | 用途 |
|-----------|------|------|
| profiles | ✅ | ユーザープロフィール |
| dogs | ✅ | 犬情報 |
| areas | ✅ | エリア情報（箱根/横浜/鎌倉） |
| official_routes | ✅ | 公式ルート |
| walks | ✅ | 散歩記録（Daily/Outing） |
| walk_photos | 🔄 | 散歩中の写真（Phase 3） |
| pins | ✅ | ピン投稿 |
| pin_photos | ✅ | ピン写真 |
| badges | ✅ | バッジマスタ（17種類） |
| user_badges | ✅ | ユーザーバッジ獲得記録 |
| follows | ✅ | フォロー関係 |
| likes | ✅ | いいね |
| notifications | ✅ | 通知 |

### Supabase Storage バケット実装状況

| バケット名 | 状態 | 用途 |
|-----------|------|------|
| profile-avatars | ✅ | プロフィール画像 |
| dog-photos | ✅ | 犬の写真 |
| pin_photos | ✅ | ピン投稿写真 |
| walk-photos | ❌ | 散歩中の写真（Phase 3で作成予定） |

---

## 既知の問題と対応状況

### 🚨 保留中の重大問題

#### 1. エリア一覧読み込みエラー（最優先）

**症状**:
```
Exception: Failed to fetch areas: type 'Null' is not a subtype of type 'num' in type cast
```

**影響範囲**:
- ❌ AreaListScreen が表示できない
- ❌ おでかけ散歩フローが開始できない
- ⚠️ ホーム画面の「エリアを探す」ボタンが機能しない

**試行した解決策**（すべて失敗）:
1. Area.fromJson修正（GEOGRAPHY型の複雑な解析ロジック）
2. get_areas_simple() RPC作成（ST_X/ST_Y座標変換）
3. area_provider.dart更新（RPC使用）
4. FutureProvider.autoDispose（キャッシュ対策）
5. デバッグログ追加
6. 再試行ボタン追加
7. 完全再起動・再インストール

**現在の状態**: **保留** - Phase 3完了後に再度取り組む

#### 2. ホーム画面スクロール問題

**症状**:
- クイックアクション（4ボタン）の下にコンテンツがあるがスクロールできない

**現在の状態**: **保留** - エリア一覧エラー解決後に再確認

#### 3. 写真アップロードバケット名不一致

**症状**:
- PhotoServiceで `route-photos` バケットを使用しているが存在しない

**対策**:
1. ❌ `walk-photos` バケット作成（SQL実行必要）
2. ⚠️ PhotoServiceのバケット名修正（`route-photos` → `walk-photos`）

**現在の状態**: **Phase 3実装中**

### ⚠️ 軽微な問題

#### 4. 地図タイル表示の断続的エラー

**症状**:
- Thunderforest API で断続的に401エラー
- 原因: APIキー期限切れまたはレート制限

**対策**:
- ✅ APIキー更新済み（`8c3872c0b1d54471a5e0c685ce76e6ff`）
- ⚠️ 問題が継続する場合はフリー枠の確認必要

---

## 次のアクション（Phase 3完了）

### 優先度A: 写真アップロード機能の完成

1. **Storageバケット作成**
   ```sql
   -- Supabaseで実行
   INSERT INTO storage.buckets (id, name, public)
   VALUES ('walk-photos', 'walk-photos', true);
   ```

2. **PhotoServiceのバケット名修正**
   ```dart
   // lib/services/photo_service.dart
   // 変更前: 'route-photos'
   // 変更後: 'walk-photos'
   await _supabase.storage
       .from('walk-photos')  // ← 修正
       .upload(filePath, file);
   ```

3. **カメラボタンへの統合**
   ```dart
   // lib/screens/daily/daily_walking_screen.dart
   // 既にボタンは追加済み、PhotoServiceを呼び出す処理を実装
   ```

4. **テスト実施**
   - [ ] 日常散歩開始 → GPS追跡
   - [ ] 写真撮影ボタンタップ
   - [ ] 写真撮影 → アップロード
   - [ ] Supabase Storageで確認
   - [ ] 散歩終了 → Records Tabで確認

### 優先度B: 保留中問題の再チャレンジ

1. **エリア一覧エラーの解決**
   - Supabaseで直接RPC実行
   - 返されるデータ形式を確認
   - 必要に応じてArea.fromJsonを再修正

2. **ホーム画面スクロール問題**
   - エリアエラー解決後に再確認

---

## 開発環境情報

### サンドボックス環境
- **パス**: `/home/user/webapp/wanmap_v2`
- **用途**: コード編集・git操作

### ローカルMac環境
- **パス**: `/Users/atsushinarisawa/projects/webapp/wanmap_v2`
- **用途**: アプリ実行・テスト・ビルド

### 開発フロー
```
1. サンドボックスでコード編集
2. git add . && git commit -m "メッセージ"
3. git push origin main
4. ローカルMacで git pull origin main
5. flutter clean && flutter pub get
6. iOS Simulatorで完全再起動テスト
```

---

## 外部サービス情報

### Supabase
- **URL**: https://jkpenklhrlbctebkpvax.supabase.co
- **ANON KEY**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`（.envファイル参照）

### Thunderforest Maps API
- **API KEY**: `8c3872c0b1d54471a5e0c685ce76e6ff`
- **タイルセット**: Outdoors
- **Free tier**: 150,000リクエスト/月

### GitHub
- **リポジトリ**: https://github.com/AtsushiNarisawa/wanmap_v2
- **ブランチ**: main

### テストアカウント
- **test1@example.com** / password123 （データ最多）
- **test2@example.com** / password123
- **test3@example.com** / password123

---

**最終更新日**: 2025-11-24  
**ドキュメントバージョン**: 1.0  
**作成者**: WanMap v2 Development Team  
**プロジェクトオーナー**: Atsushi Narisawa (成沢敦史)
